<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Test IPP — Inventaire Psychologique de Performance</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>
:root{--ink:#0f172a;--line:#e5e7eb;--muted:#475569}
*{box-sizing:border-box}html,body{margin:0;background:#ffffff;color:var(--ink);font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial}
header.hero{display:flex;flex-direction:column;align-items:center;gap:14px;padding:28px 12px;background:#ffffff;border-bottom:1px solid var(--line)}
.logo{width:420px;max-width:92vw;height:auto;object-fit:contain;display:block}
.subtitle{color:var(--muted)}
.rules{max-width:980px}
.rules ul{margin:8px 0 0 0;padding-left:18px;color:#334155;line-height:1.6}
.cta{background:var(--ink);color:#fff;border:1px solid var(--ink);border-radius:10px;padding:12px 18px;cursor:pointer}
.cta:disabled{opacity:.6;cursor:not-allowed}
.hidden{display:none}
main{max-width:1200px;margin:18px auto;padding:0 14px}
.card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:16px;margin-bottom:16px}
.answers{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.option{border:1px solid #cbd5e1;background:#f8fafc;border-radius:12px;padding:10px;cursor:pointer;position:relative}
.option.selected{border-color:#2563eb;background:#eff6ff}
.rank-badge{position:absolute;top:8px;right:8px;background:#2563eb;color:#fff;border-radius:999px;width:26px;height:26px;display:flex;align-items:center;justify-content:center;font-weight:700}
.nav{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
.nav .info{margin-left:auto;color:#475569}
.primary{background:var(--ink);color:#fff;border:1px solid var(--ink);border-radius:10px;padding:8px 12px}
.grid2{display:grid;grid-template-columns:1.1fr 0.9fr;gap:14px}
.center{text-align:center}
#resultTable{width:100%;border-collapse:collapse;font-size:14px}
#resultTable th,#resultTable td{border:1px solid #e2e8f0;padding:8px 10px;text-align:left;vertical-align:top}
#resultTable th:nth-child(2),#resultTable td:nth-child(2){text-align:right;width:70px}
.kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0}
.kpi .b{background:#f1f5f9;border:1px solid #e2e8f0;border-radius:10px;padding:8px}
@page { size: A4; margin: 12mm; }
.like-a4{width:794px;min-height:1123px;margin:0 auto 16px auto;padding:18px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
#pgNarratif h3{margin:18px 0 6px}
#pgNarratif p{line-height:1.6;margin:6px 0}
.toolbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
footer{padding:12px;text-align:center;color:#64748b}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;color:#1e293b;font-size:12px;margin-left:6px}
blockquote{background:#f8fafc;border-left:4px solid #94a3b8;margin:8px 0;padding:8px 10px;border-radius:6px}
ul{padding-left:18px}
.dot{width:12px;height:12px;border-radius:50%;display:inline-block}
.dot.garant{background:#1f77b4}.dot.conq{background:#d62728}.dot.bienv{background:#2ca02c}.dot.fiable{background:#6b21a8}.dot.vision{background:#0284c7}.dot.spont{background:#f59e0b}
.legend{display:flex;gap:10px;justify-content:center;margin:6px 0 12px}
hr.sep{border:0;border-top:1px solid #e2e8f0;margin:10px 0}
</style>
</head>
<body>

<header class="hero">
  <!-- Mets ton fichier de logo au nom logo.png dans le dépôt -->
  <img class="logo" id="logo" src="logo.png" alt="Logo — Académie de Performances" onerror="this.style.display='none'">
  <h1>Test IPP — Inventaire Psychologique de Performance</h1>
  <p class="subtitle">Jeunes • 12–25 ans — Académie de Performances</p>
  <button id="startBtn" class="cta">Commencer</button>
  <div class="rules">
    <ul>
      <li>Installez-vous dans un moment calme, sans dérangement.</li>
      <li>Répondez avec spontanéité — ne suranalysez pas.</li>
      <li>À chaque question, classez <strong>3 à 6</strong> propositions (1→6).</li>
      <li>Durée : jusqu’à 45 minutes.</li>
    </ul>
  </div>
</header>

<main id="app" class="hidden">
  <section id="quiz" class="card"></section>

  <section id="report" class="card hidden">
    <div class="toolbar">
      <div>
        <h2 style="margin:0">Votre rapport IPP 
          <span id="badgeADN" class="badge"></span>
          <span id="badgeCAP" class="badge"></span>
        </h2>
      </div>
      <div>
        <button id="pdf" class="primary">Exporter PDF</button>
      </div>
    </div>

    <div class="page like-a4" id="pg1">
      <h3 class="center">Étoile IPP — ❤️ ADN (100%) • ⭐ Cap (actuel) • ⚪ Caps vécus</h3>
      <div class="legend">
        <span><span class="dot garant"></span> Garant</span>
        <span><span class="dot conq"></span> Conquérant</span>
        <span><span class="dot bienv"></span> Bienveillant</span>
        <span><span class="dot fiable"></span> Fiable</span>
        <span><span class="dot vision"></span> Visionnaire</span>
        <span><span class="dot spont"></span> Spontané</span>
      </div>
      <div class="grid2">
        <canvas id="etoile" height="380" aria-label="Étoile IPP"></canvas>
        <div>
          <div class="kpi">
            <div class="b"><strong>ADN :</strong> <span id="kpiADN"></span></div>
            <div class="b"><strong>Cap actuel :</strong> <span id="kpiCAP"></span></div>
            <div class="b"><strong>Caps vécus :</strong> <span id="kpiLived"></span></div>
          </div>
          <table id="resultTable">
            <thead><tr><th>Profil</th><th>%</th><th>Repère</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="page like-a4" id="pg2">
      <h3 class="center">Boussole & Pyramide</h3>
      <div class="grid2">
        <canvas id="boussole" height="380" aria-label="Boussole IPP"></canvas>
        <canvas id="pyramide" height="380" aria-label="Pyramide IPP"></canvas>
      </div>
      <blockquote>
        <strong>Lecture rapide :</strong> la boussole met en évidence vos environnements porteurs (structuration, action, relation, valeurs, introspection, spontanéité).
        La pyramide illustre une montée d’activation maîtrisée (niveau 1 à 3).
      </blockquote>
    </div>

    <div class="page like-a4" id="pgNarratif">
      <div id="welcome"></div>
      <hr class="sep"/>
      <div id="sections"></div>
    </div>
  </section>
</main>

<footer><small>© IPP — Académie de Performances</small></footer>

<script>
const PROFILES = ["Garant","Conquérant","Bienveillant","Fiable","Visionnaire","Spontané"];
const $ = sel => document.querySelector(sel);

// 10 formulations par profil (variété garanties par vignette)
const BANK = {
  "Garant":[
    "Vous posez un plan en trois étapes et vous démarrez.",
    "Vous vérifiez les critères d’évaluation et alignez votre méthode.",
    "Vous découpez la tâche en blocs de 25 minutes avec une pause.",
    "Vous clarifiez la consigne puis lancez une action simple et propre.",
    "Vous commencez par l’étape critique pour sécuriser la suite.",
    "Vous préparez le matériel nécessaire et vous démarrez.",
    "Vous structurez vos notes en un sommaire clair avant d’agir.",
    "Vous listez les dépendances et sécurisez les points bloquants.",
    "Vous créez une checklist minimaliste puis vous cochez la première étape.",
    "Vous fixez un ordre de priorité et vous lancez le point n°1."
  ],
  "Conquérant":[
    "Vous choisissez le défi prioritaire et vous le réglez tout de suite.",
    "Vous annoncez un jalon mesurable à H+30 minutes et vous y allez.",
    "Vous tranchez puis vous avancez vite, quitte à ajuster ensuite.",
    "Vous prenez le lead et distribuez les rôles pour créer l’élan.",
    "Vous passez en mode action immédiatement pour produire un résultat.",
    "Vous ciblez l’obstacle principal et vous le neutralisez.",
    "Vous engagez un sprint court avec un objectif visible.",
    "Vous affichez un score à battre et vous démarrez.",
    "Vous verrouillez un premier gain concret.",
    "Vous éliminez la friction la plus coûteuse et vous continuez."
  ],
  "Bienveillant":[
    "Vous installez un climat calme et vous démarrez en douceur.",
    "Vous demandez ou offrez un bref soutien, puis vous lancez la première action.",
    "Vous vous encouragez puis vous engagez un premier pas atteignable.",
    "Vous vérifiez que chacun se sent inclus avant d’avancer.",
    "Vous respirez deux minutes et vous vous recentrez avant d’agir.",
    "Vous clarifiez les attentes réciproques et vous y allez.",
    "Vous sécurisez la relation clé avant de vous engager.",
    "Vous transformez la pression en cadence respirée.",
    "Vous commencez par une action qui vous met en confiance.",
    "Vous aménagez un micro-espace serein puis vous lancez."
  ],
  "Fiable":[
    "Vous vous alignez sur un engagement réaliste et vous le tenez.",
    "Vous clarifiez qui fait quoi pour quand, puis vous avancez.",
    "Vous vérifiez que la solution respecte vos critères et vos valeurs.",
    "Vous rappelez la règle du jeu et vous vous y conformez d’abord.",
    "Vous choisissez l’action la plus juste, même si elle est discrète.",
    "Vous définissez un cadre simple et vous le respectez.",
    "Vous précisez les limites et vous tenez votre cap.",
    "Vous validez la cohérence avec vos convictions avant d’agir.",
    "Vous formalisez un petit contrat avec vous-même.",
    "Vous choisissez l’option la plus loyale et vous démarrez."
  ],
  "Visionnaire":[
    "Vous prenez dix minutes seul pour cadrer l’idée clé.",
    "Vous visualisez le résultat final puis écrivez la première action.",
    "Vous simplifiez le concept pour le rendre actionnable tout de suite.",
    "Vous créez un mini-prototype puis vous observez.",
    "Vous schématisez l’objectif et en déduisez un pas concret.",
    "Vous transformez l’intuition en une action mesurable.",
    "Vous isolez le principe essentiel et vous le testez.",
    "Vous faites un croquis puis vous passez à l’essai 1.",
    "Vous réduisez l’idée à un geste simple.",
    "Vous fixez une hypothèse et vous la vérifiez en 10 minutes."
  ],
  "Spontané":[
    "Vous transformez la tâche en jeu et vous lancez un sprint.",
    "Vous mettez un minuteur de dix minutes pour voir jusqu’où vous allez.",
    "Vous démarrez par la partie la plus stimulante pour vous embarquer.",
    "Vous vous donnez un petit défi personnel et vous foncez.",
    "Vous variez la forme pour garder l’envie et vous avancez.",
    "Vous vous fixez une récompense rapide à l’issue du premier bloc.",
    "Vous lancez un chrono et vous jouez la vitesse.",
    "Vous changez d’angle pour relancer le plaisir.",
    "Vous commencez par un format express et fun.",
    "Vous ajoutez une touche d’originalité et vous partez."
  ]
};

// 10 thèmes × 6 questions = 60 vignettes (chaque question : 6 formulations uniques)
const THEMES = [
 ["Révisions / examens",[
   "Vous avez trois chapitres à revoir ce soir : quelle est votre première action ?",
   "Examen blanc demain : que faites-vous en premier ?",
   "Vous sentez du retard dans vos révisions : que décidez-vous maintenant ?",
   "Devoir à rendre ce soir : par quoi commencez-vous ?",
   "Deux jours avant un contrôle majeur : quelle démarche initiez-vous ?",
   "Vous êtes fatigué(e) mais il faut travailler : comment lancez-vous la machine ?"
 ]],
 ["Projet de groupe",[
   "Deux membres sont silencieux et un plan d’action est attendu vendredi midi : que faites-vous d’abord ?",
   "Vous devez répartir les rôles dans un projet collectif : comment procédez-vous ?",
   "Votre groupe est en retard sur la présentation : quelle est votre première démarche ?",
   "Un camarade n’a pas rendu sa part : quelle est votre priorité immédiate ?",
   "Vous devez lancer une réunion de projet : quelle action engagez-vous en premier ?",
   "Rendu demain et l’équipe n’est pas prête : que décidez-vous ?"
 ]],
 ["Sport / compétition",[
   "Séance technique importante avant un match ce week-end : par quoi commencez-vous ?",
   "Test chronométré demain : comment vous préparez-vous ?",
   "Pression avant une compétition : quelle première action posez-vous ?",
   "Erreur en match : comment réagissez-vous immédiatement ?",
   "Geste technique à améliorer : que faites-vous en premier ?",
   "Finale décisive : quelle est votre première démarche ?"
 ]],
 ["Réseaux sociaux / distractions",[
   "Les notifications vous coupent pendant vos devoirs : que faites-vous en premier ?",
   "Vous perdez du temps sur le téléphone avant de travailler : quelle est votre réaction ?",
   "Vous devez rédiger un devoir mais les réseaux vous tentent : que décidez-vous ?",
   "Environnement bruyant : quelle action posez-vous pour vous concentrer ?",
   "Votre attention décroche pendant une séance d’étude : que faites-vous tout de suite ?",
   "Un ami vous écrit pendant vos révisions : comment réagissez-vous ?"
 ]],
 ["Orientation / choix d’avenir",[
   "Vous hésitez entre deux filières : quelle est votre première démarche ?",
   "Vous devez choisir une option importante : que faites-vous en priorité ?",
   "Vous doutez de votre orientation : quelle première action prenez-vous ?",
   "Deux propositions d’avenir vous intéressent : comment tranchez-vous ?",
   "Décision rapide de parcours à prendre : par quoi commencez-vous ?",
   "Vous craignez de regretter un choix : quelle stratégie initiale adoptez-vous ?"
 ]],
 ["Prise de parole / oral",[
   "Préparer un oral important avec peu de temps : que faites-vous d’abord ?",
   "Parler devant la classe sans préparation : comment réagissez-vous ?",
   "Stress avant de prendre la parole : quelle est votre première action ?",
   "Convaincre un jury : par quoi commencez-vous ?",
   "Préparer un exposé : quelle est votre première étape ?",
   "Improviser une réponse en public : que faites-vous immédiatement ?"
 ]],
 ["Conflits / limites",[
   "On vous demande trop de choses à la fois : comment réagissez-vous en premier ?",
   "Dire non à un ami sans le blesser : que faites-vous en priorité ?",
   "Vous vous sentez débordé(e) par les attentes : quelle première action ?",
   "Un camarade vous met la pression : quelle est votre réponse initiale ?",
   "Désaccord avec un coach/prof : que faites-vous d’abord ?",
   "Vous devez poser une limite claire : comment vous y prenez-vous ?"
 ]],
 ["Organisation / temps",[
   "Semaine chargée : par quoi commencez-vous pour garder de l’énergie ?",
   "Plusieurs devoirs à rendre demain : quelle est votre première démarche ?",
   "Organiser vos journées pour tenir vos objectifs : que faites-vous ?",
   "Emploi du temps déséquilibré : que décidez-vous en priorité ?",
   "Retard accumulé : comment redémarrez-vous ?",
   "Rythme trop irrégulier : quelle est votre première action ?"
 ]],
 ["Créativité / projets perso",[
   "Vous avez une idée à développer : quelle est votre première démarche ?",
   "Vous voulez lancer un projet personnel : que faites-vous d’abord ?",
   "Beaucoup d’idées en tête : comment démarrez-vous ?",
   "Créer quelque chose de nouveau : quelle est votre première action ?",
   "Trouver une solution originale à un problème : que faites-vous ?",
   "Envie d’innover : quelle est votre première démarche ?"
 ]],
 ["Bien-être / énergie",[
   "Vous dormez mal à l’approche des examens : quelle est votre première action ?",
   "Gros coup de fatigue : que décidez-vous ?",
   "Retrouver un rythme de sommeil régulier : par quoi commencez-vous ?",
   "Énergie en baisse : quelle est votre priorité ?",
   "Difficulté à récupérer après un effort : que faites-vous en premier ?",
   "Stress avant de dormir : quelle première démarche adoptez-vous ?"
 ]]
];

// Construit 60 vignettes × 6 options (chaque question = 6 formulations uniques)
const QUESTIONS = [];
(function buildQuestions(){
  let id=1;
  const pick = (arr, used) => {
    for(let k=0;k<200;k++){ const c=arr[Math.floor(Math.random()*arr.length)]; if(!used.has(c)){ used.add(c); return c; } }
    return arr[0];
  };
  THEMES.forEach(([theme, prompts])=>{
    prompts.forEach(prompt=>{
      const used=new Set();
      const options=PROFILES.map(p=>({ label: pick(BANK[p], used), profil: p }));
      QUESTIONS.push({ prompt: `${id}. ${prompt}`, weight:1, options });
      id++;
    });
  });
})();

/* ===== Quiz ===== */
let answers = new Array(QUESTIONS.length).fill(null), current = 0;
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('startBtn').addEventListener('click', () => {
    document.getElementById('app').classList.remove('hidden');
    renderQ();
    window.scrollTo({top:document.querySelector('#app').offsetTop, behavior:'smooth'});
  });
  document.getElementById('pdf').addEventListener('click', exportPdf);
});

function renderQ(){
  const q = QUESTIONS[current];
  if(!Array.isArray(answers[current])) answers[current]=[];
  const ranked = answers[current];
  const rankOf = i => { const p = ranked.indexOf(i); return p===-1?null:p+1; };

  const opts = q.options.map((o,i)=>`
    <div class="option ${rankOf(i)?'selected':''}" data-i="${i}">
      ${o.label}
      ${rankOf(i)?`<span class="rank-badge">${rankOf(i)}</span>`:''}
    </div>`).join('');

  const nav = `
    <div class="nav">
      <button id="prev" ${current===0?'disabled':''}>Précédent</button>
      <button id="next" ${(ranked.length<3 || current===QUESTIONS.length-1)?'disabled':''}>Suivant</button>
      <button id="finish" class="primary" ${(ranked.length<3 || current!==QUESTIONS.length-1)?'disabled':''}>Terminer</button>
      <span class="info">Question ${current+1}/${QUESTIONS.length} — Choix : ${ranked.length}</span>
    </div>`;

  document.getElementById("quiz").innerHTML = `
    <h3>${q.prompt}</h3>
    <div class="answers">${opts}</div>
    <p>Classez <b>3 à 6</b> réponses (clic pour sélectionner / désélectionner). L’ordre = votre préférence.</p>
    ${nav}`;

  document.getElementById("quiz").querySelectorAll(".option").forEach(el=>{
    el.addEventListener("click",()=>{
      const i = +el.dataset.i;
      const p = ranked.indexOf(i);
      if(p===-1){ if(ranked.length<6) ranked.push(i); }
      else { ranked.splice(p,1); }
      renderQ();
    });
  });
  document.getElementById('prev').onclick = ()=>{ if(current>0){ current--; renderQ(); } };
  document.getElementById('next').onclick = ()=>{ if(current<QUESTIONS.length-1 && ranked.length>=3){ current++; renderQ(); } };
  document.getElementById('finish').onclick = ()=>{ if(ranked.length>=3){ const r=compute(); renderReport(r); window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'}); } };
}

/* ===== Scoring ADN / Cap / Caps vécus ===== */
function compute(){
  const weights=[6,5,4,3,2,1];
  const P=[...PROFILES];
  const score=Object.fromEntries(P.map(p=>[p,0]));
  const rank1=Object.fromEntries(P.map(p=>[p,0]));
  const top2=Object.fromEntries(P.map(p=>[p,0]));
  const Q=QUESTIONS.length;

  QUESTIONS.forEach((q,qi)=>{
    const ranked=answers[qi]||[];
    ranked.forEach((opt,idx)=>{
      const p=q.options[opt].profil;
      score[p]+=(q.weight||1)*(weights[idx]||0);
      if(idx===0) rank1[p]+=1;
      if(idx<=1) top2[p]+=1;
    });
  });

  const ADN = Object.entries(score).sort((a,b)=>b[1]-a[1])[0][0];

  // Fenêtre récente pour CAP
  const startIdx=Math.max(0, Q - Math.max(20, Math.floor(Q/3)));
  const winScore=Object.fromEntries(P.map(p=>[p,0]));
  const winTop2=Object.fromEntries(P.map(p=>[p,0])); const winLen=Q-startIdx;
  for(let qi=startIdx; qi<Q; qi++){
    const ranked=answers[qi]||[];
    ranked.forEach((opt,idx)=>{ const p=QUESTIONS[qi].options[opt].profil;
      winScore[p]+= (QUESTIONS[qi].weight||1)*(weights[idx]||0);
      if(idx<=1) winTop2[p]+=1;
    });
  }
  let capCandidates = P.filter(p=>p!==ADN).map(p=>[p,winScore[p]]).sort((a,b)=>b[1]-a[1]);
  let CAP=null;
  if(capCandidates.length){ const [p1,v1]=capCandidates[0]; const v2=capCandidates[1]?.[1]??0;
    const condTop2=(winTop2[p1]/Math.max(1,winLen))>=0.30;
    const condDelta=(v2===0)?true:((v1-v2)/Math.max(1,v2)>=0.05);
    if(condTop2 && v1>0) CAP=p1;
  }

  // Caps vécus
  const lived = P.filter(p=>p!==ADN && p!==CAP).map(p=>{
    const s=top2[p]/Q; const e=rank1[p]/Q;
    const meanProxy=(Q-top2[p])/(Q||1)*3;
    const stable=meanProxy<=2.8;
    const ok=(s>=0.35 || e>=0.15) && stable;
    return {p,ok,raw:score[p]};
  }).filter(x=>x.ok).sort((a,b)=>b.raw-a.raw).map(x=>x.p).slice(0,2);

  // Pourcentages : ADN=100%, caps vécus=100%, CAP calibré <100, autres inférieurs
  const ADNraw=Math.max(score[ADN],1);
  const perc=Object.fromEntries(P.map(p=>[p,Math.round((score[p]/ADNraw)*80)]));
  perc[ADN]=100;
  lived.forEach(p=>{ perc[p]=100; });
  if(CAP) perc[CAP]=Math.max(60, Math.min(95, perc[CAP]));
  P.forEach(p=>{
    if(p!==ADN && p!==CAP && !lived.includes(p)){
      perc[p]=Math.min((CAP?perc[CAP]-1:95), perc[p]);
    }
    perc[p]=Math.max(0,Math.min(100,perc[p]));
  });

  return {ADN,CAP,lived,perc,score};
}

/* ===== Rapport narratif enrichi (≈20–30 pages PDF) ===== */
function chunk(text){
  return text.split("\n").map(t=>t.trim()).filter(Boolean).map(t=>`<p>${t}</p>`).join("");
}

function LONG_REPORT(adn, cap){
  const intro = [
"Bienvenue — Votre ADN "+adn+" est votre socle de performance. Il structure votre manière de réfléchir, de décider et d’avancer.",
"Actuellement, votre Cap "+(cap||adn)+" représente l’expression prioritaire de votre énergie. Il influence votre façon d’entrer en action, d’apprendre et de vous organiser.",
"Ce rapport est un guide opérationnel : concret, applicable, ancré dans vos environnements (études, sport, social). Vous y trouverez des exemples réalistes, des routines et des plans d’action (30/60/90)."
  ].join("\n\n");

  const sections = [
    {h:"1) Votre duo énergétique", b:[
      "ADN "+adn+" — zone de force et de récupération d’énergie.",
      "Cap "+(cap||adn)+" — style d’expression du moment (évolutif).",
      "But : alimenter l’ADN et exprimer le Cap sans excès."
    ]},
    {h:"2) Perceptions et décisions", b:[
      "Filtre ADN (stabilité) → arbitrage Cap (priorité).",
      "Alterner micro-tests (Cap) et vérifications ciblées (ADN).",
      "Repère : la « première action juste » se fait en < 5 min."
    ]},
    {h:"3) Points forts différenciants", list:[
      "Clarté d’objectif et tri des priorités.",
      "Rituels efficaces (préparer / agir / consolider).",
      "Focalisation sur l’essentiel + itérations rapides.",
      "Courage de décider en incertitude modérée."
    ]},
    {h:"4) Besoins psychologiques — à nourrir", list:[
      "Reconnaissance spécifique et au bon moment.",
      "Rythme régulier + boucles de récupération courtes.",
      "Ambiance adaptée : outils, calme, distractions maîtrisées.",
      "Droit à l’essai : version 1 imparfaite autorisée."
    ]},
    {h:"5) Communication qui vous booste", b:[
      "Format : Fait → Impact → Besoin → Demande.",
      "Clarifie vite ce qui compte et aligne les efforts."
    ], list:[
      "« Fait : le plan est prêt. Impact : on gagne 1 jour. Besoin : un OK. Demande : validation avant 18h. »",
      "« Fait : j’ai un doute chiffré. Impact : risque de retard. Besoin : un regard 10 min. Demande : dispo à 14h ? »"
    ]},
    {h:"6) Études — méthode d’apprentissage", b:[
      "Transformer l’info en action mémorielle, en cycles courts et visibles."
    ], list:[
      "Séquences 25/5 + récap 60 s.",
      "Fiches 3 idées + 1 exemple.",
      "Auto-tests fréquents (QCM/flashcards).",
      "Un jalon par jour (schéma, quiz, paragraphe)."
    ]},
    {h:"7) Sport — routines de performance", b:[
      "Routines brèves, mesurables, reliées au geste clé."
    ], list:[
      "Pré-compétition : respiration 2 min + image du geste + consigne unique.",
      "Entraînement : 1 axe technique/série, score rapide, récup active.",
      "Récupération : 8 min mobilité + hydratation + retour au calme.",
      "Débrief : 3 faits / 1 enseignement / 1 action."
    ]},
    {h:"8) Social — coopération utile", b:[
      "Efficacité accrue quand rôles explicites + reconnaissance ciblée."
    ], list:[
      "Dire non sans casser le lien : alternative claire.",
      "Canal unique pour le suivi.",
      "Feedback bref, précis, centré sur le prochain pas."
    ]},
    {h:"9) Organisation — semaine type", list:[
      "Lundi 15 min : 3 objectifs (dont 1 prioritaire/jour).",
      "Timeboxing : créneaux fermés + minuteur.",
      "Vendredi 15 min : garder / ajuster / supprimer.",
      "Rangement fin de journée : prépare l’élan du lendemain."
    ]},
    {h:"10) Stress — 3 niveaux et antidotes", b:[
      "N1 : signaux faibles (tension/rigidité). Antidote : respiration 90 s + micro-action.",
      "N2 : défenses (perfectionnisme/impulsivité/retrait). Antidote : décorréler enjeu/identité + 1 pas prioritaire.",
      "N3 : rupture (blocage/conflit/abandon). Antidote : protocole d’urgence + regard externe + petit engagement."
    ], list:[
      "Protocole 3×30 : 30 s respiration, 30 s choix, 30 s action.",
      "Phrase d’ancrage : « Je fais juste le premier pas mesurable. »"
    ]},
    {h:"11) Plans d’action 30-60-90", list:[
      "J+30 : rituel quotidien (10–15 min) + trace visible.",
      "J+60 : bilan hebdo + feedback pair/coach.",
      "J+90 : projet-signature aligné ADN, avec un défi Cap."
    ]},
    {h:"12) Risques et erreurs à éviter", list:[
      "Surenchère d’objectifs au lieu d’un choix clair.",
      "Chercher le parfait avant de tester.",
      "Ignorer trop longtemps les besoins psychologiques."
    ]},
    {h:"13) Exemples — Études / Sport / Social", b:[
      "Études : 1 chapitre → 3 fiches + 10 QCM, 1 résultat/jour.",
      "Sport : 1 axe, 1 consigne, 1 mesure ; débrief 3/1/1.",
      "Social : demande claire, canal unique, délai réaliste."
    ]},
    {h:"14) Annexes — outils prêts à l’emploi", list:[
      "Checklist démarrage 60 s.",
      "Gabarit fiche 3-1-1.",
      "Modèle Fait → Impact → Besoin → Demande.",
      "Tableau hebdo (3 objectifs, 1 prioritaire/jour)."
    ]},
    {h:"Conclusion", b:[
      "Performance durable = ADN (stabilité) + Cap (élan) + environnement ajusté.",
      "De petits pas répétés font les grandes trajectoires."
    ]}
  ];

  let html = "<h3>Message de bienvenue</h3>" + chunk(intro);
  sections.forEach(sec => {
    html += `<h3>${sec.h}</h3>`;
    if(sec.b) html += chunk(sec.b.join("\n\n"));
    if(sec.list) html += "<ul>" + sec.list.map(x=>`<li>${x}</li>`).join("") + "</ul>";
  });
  return html;
}

function renderReport(r){
  document.getElementById('report').classList.remove('hidden');
  document.getElementById('badgeADN').textContent = `ADN : ${r.ADN}`;
  document.getElementById('badgeCAP').textContent = `Cap actuel : ${r.CAP || r.ADN}`;
  document.getElementById('kpiADN').textContent = r.ADN;
  document.getElementById('kpiCAP').textContent = r.CAP || "—";
  document.getElementById('kpiLived').textContent = r.lived.length ? r.lived.join(', ') : "—";

  const tbody=document.querySelector("#resultTable tbody"); tbody.innerHTML="";
  PROFILES.forEach(p=>{
    const rep=(p===r.ADN?"❤️":(p===r.CAP?"⭐":(r.lived.includes(p)?"⚪":"")));
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p}</td><td>${r.perc[p]}%</td><td>${rep}</td>`;
    tbody.appendChild(tr);
  });

  new Chart(document.querySelector("#etoile").getContext('2d'),{type:'radar',
    data:{labels:[...PROFILES],datasets:[{data:PROFILES.map(l=>r.perc[l]||0),borderColor:'#0f172a',backgroundColor:'rgba(15,23,42,0.08)',pointRadius:3}]},
    options:{plugins:{legend:{display:false}},scales:{r:{min:0,max:100,ticks:{stepSize:20}}}}
  });
  new Chart(document.querySelector("#boussole").getContext('2d'),{type:'radar',
    data:{labels:["Structuré","Action","Relation","Valeurs","Introspection","Spontanéité"],
          datasets:[{data:["Garant","Conquérant","Bienveillant","Fiable","Visionnaire","Spontané"]
            .map(l=>r.perc[l]||0),borderColor:'#0f172a',backgroundColor:'rgba(15,23,42,0.08)'}]},
    options:{plugins:{legend:{display:false}},scales:{r:{min:0,max:100}}}
  });
  new Chart(document.querySelector("#pyramide").getContext('2d'),{type:'bar',
    data:{labels:["Niv 1","Niv 2","Niv 3"],datasets:[{data:[30,60,100],backgroundColor:'rgba(15,23,42,0.25)',borderColor:'#0f172a'}]},
    options:{plugins:{legend:{display:false}},scales:{y:{min:0,max:100}}}
  });

  const html = LONG_REPORT(r.ADN, r.CAP || r.ADN);
  document.getElementById('welcome').innerHTML = "";
  document.getElementById('sections').innerHTML = html;
}

/* ===== Export PDF A4 ===== */
async function exportPdf(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt',format:'a4'});
  const pages=[document.getElementById('pg1'),document.getElementById('pg2'),document.getElementById('pgNarratif')];
  for(let i=0;i<pages.length;i++){
    const el=pages[i]; const cv=await html2canvas(el,{scale:2});
    const img=cv.toDataURL('image/png'); const w=doc.internal.pageSize.getWidth(); const h=w*cv.height/cv.width;
    if(i>0) doc.addPage(); doc.addImage(img,'PNG',20,20,w-40,h-40);
  }
  doc.save('IPP_rapport.pdf');
}
</script>
</body>
</html>
